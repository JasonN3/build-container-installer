#!/usr/bin/env -S ansible-playbook -i ./ansible_inventory
---
- name: Test for flatpaks
  hosts: vm
  gather_facts: no

  tasks:
  - name: Get install GPG key
    ansible.builtin.slurp:
      src: /ostree/deploy/default/var/lib/flatpak/repo/flathub.trustedkeys.gpg
    register: found_gpg

  - name: debug
    ansible.builtin.debug:
      var: found_gpg

  - name: Get gpg key
    ansible.builtin.set_fact:
      expected_gpg: "{{ lookup('ansible.builtin.url', 'https://flathub.org/repo/flathub.flatpakrepo', split_lines=True) | replace(',', '\n') | regex_search('^GPGKey=(.*)$', '\\1', multiline=True, ignorecase=True) }}"

  - name: debug
    ansible.builtin.debug:
      var: expected_gpg
      
  - name: Test GPG key
    ansible.builtin.assert:
      that:
        - expected_gpg == found_gpg['content']
      fail_msg: "Installed GPG key does not match GPG key in flatpakrepo file"
      success_msg: "GPG key matches"

  - name: Test updating flatpak packages
    ansible.builtin.command:
      cmd: /usr/bin/flatpak update -y
